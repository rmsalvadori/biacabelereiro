unit UAtualizacoes;

interface
  type TAtualizacoes = Class
     private
       procedure alteraVersao(versao: string);
       function atualizar1_0: boolean;
       function atualizar1_0_1: boolean;
       function atualizar1_0_2: boolean;
     public
       procedure atualizar;
  End;

var
  atualizacoes: TAtualizacoes;
implementation

uses UDM, System.SysUtils;


procedure TAtualizacoes.alteraVersao(versao: string);
begin
  with dm.config do
  begin
    Refresh;
    Filter := 'id = 2';
    Edit;
    FieldByName('valor').AsString := versao;
    Post;
    Refresh;
    Filter := 'id = 2';
    dm.config2 := FieldByName('valor').AsString;
  end;
end;

function TAtualizacoes.atualizar1_0: boolean;
begin
  with dm.qry_atualizacoes do
  begin
    close;
    sql.Clear;
    sql.Add('INSERT INTO config ( id, descri, valor) VALUES ( 2,''Versao'',''1.0'')');
    Execute;
  end;
  alteraVersao('1.0');
end;

function TAtualizacoes.atualizar1_0_1: boolean;
begin
  with dm.qry_atualizacoes do
  begin
    close;
    sql.Clear;
    sql.Add('DROP VIEW vw_lista_vendas;                                                                                                                                                      '+
             'CREATE VIEW vw_lista_vendas (                                                                                                                                                  '+
             '    id,                                                                                                                                                                        '+
             '    nome,                                                                                                                                                                      '+
             '    valor,                                                                                                                                                                     '+
             '    data,                                                                                                                                                                      '+
             '    valor_descontado_cartao,                                                                                                                                                   '+
             '    valor_comiss,                                                                                                                                                              '+
             '    v_cartao,                                                                                                                                                                  '+
             '    v_dinheiro,                                                                                                                                                                '+
             '    cliente                                                                                                                                                                    '+
             ')                                                                                                                                                                              '+
             'AS                                                                                                                                                                             '+
             '    SELECT id,                                                                                                                                                                 '+
             '           CAST (ifnull(cliente, '''') AS VARCHAR (200) ) AS nome,                                                                                                               '+
             '           ifnull(sum(valor), 0) AS valor,                                                                                                                                     '+
             '           data AS data,                                                                                                                                                       '+
             '           CAST (ifnull(sum(valor_descontado_cartao), 0) AS FLOAT) AS valor_descontado_cartao,                                                                                 '+
             '           CAST (ifnull(sum(valor_comiss), 0) AS FLOAT) AS valor_comiss,                                                                                                       '+
             '           CAST (ifnull(sum(v_cartao), 0) AS FLOAT) AS v_cartao,                                                                                                               '+
             '           CAST (ifnull(sum(v_dinheiro), 0) AS FLOAT) AS v_dinheiro,                                                                                                           '+
             '           cliente                                                                                                                                                             '+
             '      FROM (                                                                                                                                                                   '+
             '               SELECT v.id,                                                                                                                                                    '+
             '                      iv.valor,                                                                                                                                                '+
             '                      iv.cartao,                                                                                                                                               '+
             '                      v.data,                                                                                                                                                  '+
             '                      v.cliente,                                                                                                                                               '+
             '                      CASE iv.cartao WHEN 1 THEN iv.valor * (1 - CAST (iv.perc_cartao AS FLOAT) / 100) ELSE iv.valor END valor_descontado_cartao,                              '+
             '                      CASE iv.cartao WHEN 1 THEN (iv.valor * (1 - CAST (iv.perc_cartao AS FLOAT) / 100) ) * (iv.comis / 100) ELSE iv.valor * (iv.comis / 100) END valor_comiss,'+
             '                      CASE iv.cartao WHEN 1 THEN iv.valor ELSE 0.0 END v_cartao,                                                                                               '+
             '                      CASE iv.cartao WHEN 0 THEN iv.valor ELSE 0.0 END v_dinheiro                                                                                              '+
             '                 FROM venda v                                                                                                                                                  '+
             '                      LEFT JOIN                                                                                                                                                '+
             '                      item_venda iv ON v.id = iv.id_venda AND                                                                                                                  '+
             '                                       iv.excluido = 0                                                                                                                         '+
             '                      LEFT JOIN                                                                                                                                                '+
             '                      servico s ON iv.id_servico = s.id                                                                                                                        '+
             '                      LEFT JOIN                                                                                                                                                '+
             '                      colaborador c ON iv.id_colaborador = c.id                                                                                                                '+
             '                WHERE v.excluido = 0                                                                                                                                           '+
             '           )                                                                                                                                                                   '+
             '     GROUP BY id;                                                                                                                                                              '
     );
    Execute;
  end;
  alteraVersao('1.01');
end;

function TAtualizacoes.atualizar1_0_2: boolean;
begin
  with dm.qry_atualizacoes do
  begin
    close;
    sql.Clear;
    sql.Add(
              'DROP VIEW vw_item_venda;                                                                                                                                                             '+
              '                                                                                                                                                                                     '+
              'CREATE VIEW vw_item_venda (                                                                                                                                                          '+
              '    id,                                                                                                                                                                              '+
              '    id_venda,                                                                                                                                                                        '+
              '    servico,                                                                                                                                                                         '+
              '    valor,                                                                                                                                                                           '+
              '    cartao,                                                                                                                                                                          '+
              '    colaborador,                                                                                                                                                                     '+
              '    valor_descontado_cartao,                                                                                                                                                         '+
              '    valor_comiss,                                                                                                                                                                    '+
              '    v_cartao,                                                                                                                                                                        '+
              '    v_dinheiro                                                                                                                                                                       '+
              ')                                                                                                                                                                                    '+
              'AS                                                                                                                                                                                   '+
              '    SELECT iv.id,                                                                                                                                                                    '+
              '           CAST (iv.id_venda AS INTEGER) AS id_venda,                                                                                                                                '+
              '           CAST (s.descri AS VARCHAR (200) ) AS descri,                                                                                                                              '+
              '           iv.valor AS valor,                                                                                                                                                        '+
              '           CAST (iv.cartao AS BOOLEAN) AS cartao,                                                                                                                                    '+
              '           CAST (c.nome AS VARCHAR (200) ) AS nome,                                                                                                                                  '+
              '           CAST (CASE iv.cartao WHEN 1 THEN (iv.valor * (1 - CAST (iv.perc_cartao AS FLOAT) / 100) ) ELSE iv.valor END AS FLOAT) AS [valor_descontado_cartao::FLOAT],                '+
              '           CAST (CASE iv.cartao WHEN 1 THEN (iv.valor * (1 - CAST (iv.perc_cartao AS FLOAT) / 100) ) * (s.comis / 100) ELSE iv.valor * (s.comis / 100) END AS FLOAT) AS valor_comiss,'+
              '           CAST (CASE iv.cartao WHEN 1 THEN iv.valor ELSE 0.0 END AS FLOAT) AS v_cartao,                                                                                             '+
              '           CAST (CASE iv.cartao WHEN 0 THEN iv.valor ELSE 0.0 END AS FLOAT) AS v_dinheiro                                                                                            '+
              '      FROM item_venda iv                                                                                                                                                             '+
              '           JOIN                                                                                                                                                                      '+
              '           servico s ON iv.id_servico = s.id                                                                                                                                         '+
              '           JOIN                                                                                                                                                                      '+
              '           colaborador c ON iv.id_colaborador = c.id                                                                                                                                 '+
              '     WHERE iv.excluido = 0;                                                                                                                                                          '+
              '                                                                                                                                                                                     '+
              'DROP VIEW vw_comissoes;                                                                                                                                                              '+
              '                                                                                                                                                                                     '+
              'CREATE VIEW vw_comissoes (                                                                                                                                                           '+
              '    id,                                                                                                                                                                              '+
              '    valor,                                                                                                                                                                           '+
              '    cartao,                                                                                                                                                                          '+
              '    data,                                                                                                                                                                            '+
              '    cliente,                                                                                                                                                                         '+
              '    descri,                                                                                                                                                                          '+
              '    comis,                                                                                                                                                                           '+
              '    colaborador,                                                                                                                                                                     '+
              '    valor_comiss                                                                                                                                                                     '+
              ')                                                                                                                                                                                    '+
              'AS                                                                                                                                                                                   '+
              '    SELECT v.id,                                                                                                                                                                     '+
              '           iv.valor AS valor,                                                                                                                                                        '+
              '           iv.cartao AS cartao,                                                                                                                                                      '+
              '           v.data,                                                                                                                                                                   '+
              '           CAST (v.cliente AS VARCHAR (200) ) AS cliente,                                                                                                                            '+
              '           CAST (s.descri AS VARCHAR (200) ) AS descri,                                                                                                                              '+
              '           iv.comis AS comis,                                                                                                                                                        '+
              '           CAST (c.nome AS VARCHAR (200) ) AS colaborador,                                                                                                                           '+
              '           CASE iv.cartao WHEN 1 THEN (iv.valor * (1 - CAST (iv.perc_cartao AS FLOAT) / 100) ) * (iv.comis / 100) ELSE iv.valor * (iv.comis / 100) END AS valor_comiss               '+
              '      FROM venda v                                                                                                                                                                   '+
              '           LEFT JOIN                                                                                                                                                                 '+
              '           item_venda iv ON v.id = iv.id_venda                                                                                                                                       '+
              '           LEFT JOIN                                                                                                                                                                 '+
              '           servico s ON iv.id_servico = s.id                                                                                                                                         '+
              '           LEFT JOIN                                                                                                                                                                 '+
              '           colaborador c ON iv.id_colaborador = c.id                                                                                                                                 '+
              '     WHERE v.excluido = 0 AND                                                                                                                                                        '+
              '           iv.excluido = 0                                                                                                                                                           '+
              '     ORDER BY colaborador,                                                                                                                                                           '+
              '              data;                                                                                                                                                                  '
     );
    Execute;
  end;
  alteraVersao('1.02');
end;

procedure TAtualizacoes.atualizar;
// PRIMEIRO NUMERO SE REFERE AO ANO EX: 2018 = 1,
// SEGUNDO NUMERO A INSERCAO DE FUNCIONALIDADES,
// TERCEIRO NUMERO A CORREÇÃO DE BUGS,
// EX: 1.223 : ANO 2018 - DUAS NOVAS FUNCIONALIDAS - 23 BUGS CORRIGIDOS
begin
  if dm.config2 = '' then
    if atualizar1_0 then
      dm.mostraMsg('Erro ao atualizar para a versão 1.0');
  if 1.01 > strtofloat(dm.config2) then
    if atualizar1_0_1 then
      dm.mostraMsg('Erro ao atualizar para a versão 1.01');
  if 1.02 > strtofloat(dm.config2) then
    if atualizar1_0_2 then
      dm.mostraMsg('Erro ao atualizar para a versão 1.02');

end;

end.
